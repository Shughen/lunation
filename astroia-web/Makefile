.PHONY: help setup install dev frontend backend test lint format docker-up docker-down docker-build clean check-env

# Couleurs pour les messages
GREEN  := \033[0;32m
YELLOW := \033[0;33m
BLUE   := \033[0;34m
RESET  := \033[0m

help: ## Affiche l'aide avec toutes les commandes disponibles
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(BLUE)â•‘       Astro.IA Web - Commandes Disponibles            â•‘$(RESET)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(RESET) %s\n", $$1, $$2}'
	@echo ""

setup: ## Installation et configuration automatique complÃ¨te du projet
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo "$(BLUE)     Astro.IA Web - Installation Automatique           $(RESET)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@# Ã‰tape 1 : VÃ©rifier et crÃ©er .env
	@echo "$(YELLOW)âžœ [1/5] VÃ©rification du fichier .env...$(RESET)"
	@if [ ! -f .env ]; then \
		echo "  â””â”€ Fichier .env introuvable, copie depuis .env.example..."; \
		cp .env.example .env; \
		echo "  â””â”€ $(GREEN)âœ“ Fichier .env crÃ©Ã© avec succÃ¨s$(RESET)"; \
		echo "  â””â”€ $(YELLOW)âš ï¸  N'oubliez pas d'Ã©diter .env avec vos vraies valeurs !$(RESET)"; \
	else \
		echo "  â””â”€ $(GREEN)âœ“ Fichier .env existe dÃ©jÃ $(RESET)"; \
	fi
	@echo ""
	@# Ã‰tape 2 : Installation Frontend
	@echo "$(YELLOW)âžœ [2/5] Installation des dÃ©pendances Frontend (npm)...$(RESET)"
	@if [ -d "frontend" ]; then \
		cd frontend && npm install; \
		echo "  â””â”€ $(GREEN)âœ“ DÃ©pendances Frontend installÃ©es$(RESET)"; \
	else \
		echo "  â””â”€ $(YELLOW)âš ï¸  Dossier frontend/ introuvable$(RESET)"; \
	fi
	@echo ""
	@# Ã‰tape 3 : Installation Backend
	@echo "$(YELLOW)âžœ [3/5] Installation des dÃ©pendances Backend (Python venv + pip)...$(RESET)"
	@if [ -d "backend" ]; then \
		cd backend && \
		if [ ! -d "venv" ]; then \
			echo "  â””â”€ CrÃ©ation de l'environnement virtuel Python..."; \
			python3 -m venv venv; \
		fi && \
		echo "  â””â”€ Installation des dÃ©pendances Python..."; \
		. venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt; \
		echo "  â””â”€ $(GREEN)âœ“ DÃ©pendances Backend installÃ©es$(RESET)"; \
	else \
		echo "  â””â”€ $(YELLOW)âš ï¸  Dossier backend/ introuvable$(RESET)"; \
	fi
	@echo ""
	@# Ã‰tape 4 : Build Docker
	@echo "$(YELLOW)âžœ [4/5] Construction des images Docker...$(RESET)"
	@if command -v docker >/dev/null 2>&1; then \
		docker-compose build --no-cache; \
		echo "  â””â”€ $(GREEN)âœ“ Images Docker construites$(RESET)"; \
	else \
		echo "  â””â”€ $(YELLOW)âš ï¸  Docker non installÃ©, Ã©tape ignorÃ©e$(RESET)"; \
	fi
	@echo ""
	@# Ã‰tape 5 : Lancer Docker Compose
	@echo "$(YELLOW)âžœ [5/5] Lancement du projet avec Docker Compose...$(RESET)"
	@if command -v docker >/dev/null 2>&1; then \
		docker-compose up -d; \
		echo "  â””â”€ $(GREEN)âœ“ Projet lancÃ© avec succÃ¨s !$(RESET)"; \
	else \
		echo "  â””â”€ $(YELLOW)âš ï¸  Docker non installÃ©, Ã©tape ignorÃ©e$(RESET)"; \
	fi
	@echo ""
	@# Message final avec URLs
	@echo "$(GREEN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(GREEN)â•‘           Installation TerminÃ©e ! ðŸŽ‰                  â•‘$(RESET)"
	@echo "$(GREEN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@echo "$(BLUE)ðŸŒ URLs Locales :$(RESET)"
	@echo "  â€¢ Frontend   â†’ $(YELLOW)http://localhost:5173$(RESET)"
	@echo "  â€¢ Backend    â†’ $(YELLOW)http://localhost:8000$(RESET)"
	@echo "  â€¢ API Docs   â†’ $(YELLOW)http://localhost:8000/docs$(RESET)"
	@echo ""
	@echo "$(BLUE)ðŸ“ Prochaines Ã©tapes :$(RESET)"
	@echo "  1. Ã‰diter le fichier .env avec vos vraies valeurs"
	@echo "  2. VÃ©rifier les logs : $(GREEN)make docker-logs$(RESET)"
	@echo "  3. AccÃ©der au frontend : $(GREEN)http://localhost:5173$(RESET)"
	@echo ""
	@echo "$(BLUE)ðŸ’¡ Commandes utiles :$(RESET)"
	@echo "  â€¢ $(GREEN)make help$(RESET)         â†’ Voir toutes les commandes"
	@echo "  â€¢ $(GREEN)make docker-logs$(RESET)  â†’ Voir les logs en temps rÃ©el"
	@echo "  â€¢ $(GREEN)make docker-down$(RESET)  â†’ ArrÃªter le projet"
	@echo ""

install: ## Installe toutes les dÃ©pendances (sans Docker)
	@echo "$(BLUE)ðŸ“¦ Installation des dÃ©pendances...$(RESET)"
	@cd frontend && npm install
	@cd backend && python3 -m venv venv && . venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt
	@echo "$(GREEN)âœ… Installation terminÃ©e !$(RESET)"

check-env: ## VÃ©rifie si .env existe
	@if [ ! -f .env ]; then \
		echo "$(YELLOW)âš ï¸  Fichier .env introuvable !$(RESET)"; \
		echo "ExÃ©cutez : $(GREEN)make setup$(RESET) ou copiez manuellement .env.example"; \
		exit 1; \
	fi

dev: check-env ## Lance frontend + backend en parallÃ¨le (sans Docker)
	@echo "$(BLUE)ðŸš€ Lancement du serveur de dÃ©veloppement...$(RESET)"
	@(trap 'kill 0' SIGINT; \
		(cd backend && . venv/bin/activate && uvicorn main:app --reload --port 8000) & \
		(cd frontend && npm run dev))

frontend: ## Lance uniquement le frontend
	@echo "$(BLUE)ðŸŽ¨ Lancement du frontend...$(RESET)"
	@cd frontend && npm run dev

backend: check-env ## Lance uniquement le backend
	@echo "$(BLUE)ðŸ Lancement du backend...$(RESET)"
	@cd backend && . venv/bin/activate && uvicorn main:app --reload --port 8000

test: ## Lance tous les tests (frontend + backend)
	@echo "$(BLUE)ðŸ§ª ExÃ©cution des tests...$(RESET)"
	@cd frontend && npm run test
	@cd backend && . venv/bin/activate && pytest

test-frontend: ## Tests frontend uniquement
	@echo "$(BLUE)ðŸ§ª Tests frontend...$(RESET)"
	@cd frontend && npm run test

test-backend: ## Tests backend uniquement
	@echo "$(BLUE)ðŸ§ª Tests backend...$(RESET)"
	@cd backend && . venv/bin/activate && pytest

lint: ## Lint tout le code (frontend + backend)
	@echo "$(BLUE)ðŸ” Linting du code...$(RESET)"
	@cd frontend && npm run lint
	@cd backend && . venv/bin/activate && ruff check . && black --check .

format: ## Formate tout le code
	@echo "$(BLUE)âœ¨ Formatage du code...$(RESET)"
	@cd frontend && npm run format
	@cd backend && . venv/bin/activate && black . && ruff --fix .

docker-build: ## Rebuild les images Docker
	@echo "$(BLUE)ðŸ³ Construction des images Docker...$(RESET)"
	@docker-compose build --no-cache
	@echo "$(GREEN)âœ… Images construites !$(RESET)"

docker-up: ## Lance Docker Compose en arriÃ¨re-plan
	@echo "$(BLUE)ðŸ³ Lancement de Docker Compose...$(RESET)"
	@docker-compose up -d
	@echo "$(GREEN)âœ… Containers lancÃ©s !$(RESET)"
	@echo ""
	@echo "$(BLUE)ðŸŒ URLs :$(RESET)"
	@echo "  â€¢ Frontend â†’ $(YELLOW)http://localhost:5173$(RESET)"
	@echo "  â€¢ Backend  â†’ $(YELLOW)http://localhost:8000$(RESET)"
	@echo "  â€¢ API Docs â†’ $(YELLOW)http://localhost:8000/docs$(RESET)"

docker-down: ## ArrÃªte Docker Compose
	@echo "$(BLUE)ðŸ›‘ ArrÃªt de Docker Compose...$(RESET)"
	@docker-compose down
	@echo "$(GREEN)âœ… Containers arrÃªtÃ©s !$(RESET)"

docker-logs: ## Affiche les logs Docker en temps rÃ©el
	@docker-compose logs -f

docker-ps: ## Liste les containers Docker actifs
	@docker-compose ps

docker-restart: ## RedÃ©marre tous les containers
	@echo "$(BLUE)ðŸ”„ RedÃ©marrage des containers...$(RESET)"
	@docker-compose restart
	@echo "$(GREEN)âœ… Containers redÃ©marrÃ©s !$(RESET)"

clean: ## Nettoie les fichiers temporaires et dÃ©pendances
	@echo "$(BLUE)ðŸ§¹ Nettoyage en cours...$(RESET)"
	@rm -rf frontend/node_modules frontend/dist
	@rm -rf backend/venv backend/__pycache__ backend/.pytest_cache
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "$(GREEN)âœ… Nettoyage terminÃ© !$(RESET)"

clean-docker: ## Nettoie les volumes et images Docker
	@echo "$(BLUE)ðŸ§¹ Nettoyage Docker...$(RESET)"
	@docker-compose down -v
	@docker system prune -f
	@echo "$(GREEN)âœ… Docker nettoyÃ© !$(RESET)"

reset: clean clean-docker setup ## Reset complet : nettoie tout et rÃ©installe
	@echo "$(GREEN)âœ… Reset complet terminÃ© !$(RESET)"
